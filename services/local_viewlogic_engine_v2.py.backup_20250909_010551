#!/usr/bin/env python3
"""
åœ°æ–¹ç«¶é¦¬ç‰ˆViewLogicå±•é–‹äºˆæƒ³ã‚¨ãƒ³ã‚¸ãƒ³ V2
ViewLogicã®4ã¤ã®ã‚µãƒ–ã‚¨ãƒ³ã‚¸ãƒ³æ©Ÿèƒ½ã‚’åœ°æ–¹ç«¶é¦¬ç‰ˆã§å®Ÿè£…:
1. å±•é–‹äºˆæƒ³ (predict_race_flow_advanced)
2. å‚¾å‘åˆ†æ (analyze_course_trend)  
3. æ¨å¥¨é¦¬åˆ¸ (recommend_betting_tickets)
4. éå»ãƒ‡ãƒ¼ã‚¿ (get_horse_history/get_jockey_history)
"""

from typing import Dict, Any, List, Optional
from .viewlogic_engine import ViewLogicEngine
from .local_dlogic_raw_data_manager_v2 import local_dlogic_manager_v2
from .local_jockey_data_manager import local_jockey_manager

class LocalViewLogicEngineV2(ViewLogicEngine):
    """åœ°æ–¹ç«¶é¦¬ç‰ˆViewLogicå±•é–‹äºˆæƒ³ã‚¨ãƒ³ã‚¸ãƒ³ V2"""
    
    def __init__(self):
        """åˆæœŸåŒ–ï¼šåœ°æ–¹ç«¶é¦¬ç‰ˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨"""
        # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–ã‚’å‘¼ã¶
        super().__init__()
        
        # åœ°æ–¹ç«¶é¦¬ç‰ˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ä¸Šæ›¸ã
        self.data_manager = local_dlogic_manager_v2
        self.jockey_manager = local_jockey_manager
        
        print(f"ğŸ‡ åœ°æ–¹ç«¶é¦¬ç‰ˆViewLogicã‚¨ãƒ³ã‚¸ãƒ³V2åˆæœŸåŒ–å®Œäº†")
        horse_count = len(self.data_manager.knowledge_data.get('horses', {}))
        jockey_count = len(self.jockey_manager.knowledge_data.get('jockeys', {}))
        print(f"   é¦¬ãƒ‡ãƒ¼ã‚¿: {horse_count}é ­, é¨æ‰‹ãƒ‡ãƒ¼ã‚¿: {jockey_count}é¨æ‰‹")
    
    def get_engine_info(self) -> Dict[str, Any]:
        """ã‚¨ãƒ³ã‚¸ãƒ³æƒ…å ±ã‚’è¿”ã™"""
        return {
            "engine_type": "LocalViewLogicEngineV2",
            "venue": "å—é–¢æ±4å ´",
            "knowledge_horses": len(self.data_manager.knowledge_data.get('horses', {})),
            "knowledge_jockeys": len(self.jockey_manager.knowledge_data.get('jockeys', {})),
            "manager_type": "V2",
            "subengines": [
                "å±•é–‹äºˆæƒ³ (predict_race_flow_advanced)",
                "å‚¾å‘åˆ†æ (analyze_course_trend)",
                "æ¨å¥¨é¦¬åˆ¸ (recommend_betting_tickets)",
                "éå»ãƒ‡ãƒ¼ã‚¿ (horse/jockey history)"
            ]
        }
    
    def get_horse_data(self, horse_name: str) -> Optional[Dict[str, Any]]:
        """é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆViewLogicDataManagerã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰"""
        return self.data_manager.get_horse_raw_data(horse_name)
    
    def predict_race_flow_advanced(self, race_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        è¨ˆç”»æ›¸é€šã‚Šã®é«˜åº¦ãªå±•é–‹äºˆæƒ³ï¼ˆåœ°æ–¹ç«¶é¦¬ç‰ˆï¼‰
        å‰åŠ3Fãƒ»å¾ŒåŠ3Fã‚’ä½¿ç”¨ã—ãŸãƒšãƒ¼ã‚¹äºˆæ¸¬ã¨è©³ç´°ãªè„šè³ªåˆ†æ
        """
        horses = race_data.get('horses', [])
        if not horses:
            return {
                'status': 'error',
                'message': 'å‡ºèµ°é¦¬æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“'
            }
        
        # å„é¦¬ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆé¦¬ç•ªä»˜ãï¼‰ - åœ°æ–¹ç‰ˆãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
        horses_data = []
        for idx, horse_name in enumerate(horses, 1):
            horse_data = self.get_horse_data(horse_name)  # ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
            if horse_data:
                horse_data['horse_number'] = race_data.get('horse_numbers', [])[idx-1] if idx-1 < len(race_data.get('horse_numbers', [])) else idx
                horses_data.append(horse_data)
        
        # ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if len(horses_data) < len(horses) * 0.3:  # 30%æœªæº€ã—ã‹ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            return {
                'status': 'warning',
                'type': 'advanced_flow_prediction',
                'race_info': {
                    'venue': race_data.get('venue', ''),
                    'race_number': race_data.get('race_number', ''),
                    'race_name': race_data.get('race_name', ''),
                    'distance': race_data.get('distance', '')
                },
                'pace_prediction': {'pace': 'ãƒ‡ãƒ¼ã‚¿ä¸è¶³', 'confidence': 0, 'zenhan_avg': 0, 'kohan_avg': 0},
                'detailed_styles': {},
                'position_stability': {},
                'flow_matching': {},
                'race_simulation': {},
                'visualization_data': {}
            }
        
        # è¦ªã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
        return super().predict_race_flow_advanced(race_data)

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
local_viewlogic_engine_v2 = LocalViewLogicEngineV2()