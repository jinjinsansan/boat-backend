"""
V2 AIãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç”¨ã®é«˜åº¦ãªå±•é–‹äºˆæƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
predict_race_flow_advancedãƒ¡ã‚½ãƒƒãƒ‰ã®å‡ºåŠ›ã«å¯¾å¿œ
"""

from typing import Dict, Any, List
import random

def get_pace_templates() -> Dict[str, List[str]]:
    """ãƒšãƒ¼ã‚¹äºˆæƒ³ã®å¤šæ§˜ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿”ã™"""
    return {
        'ãƒã‚¤ãƒšãƒ¼ã‚¹_intro': [
            "åºç›¤ã‹ã‚‰æ¿€ã—ã„å…ˆè¡Œäº‰ã„ãŒäºˆæƒ³ã•ã‚Œã€ãƒã‚¤ãƒšãƒ¼ã‚¹ã®å±•é–‹ã¨ãªã‚Šãã†ã§ã™ã€‚",
            "ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œã‹ã‚‰å„é¦¬ãŒç©æ¥µçš„ã«å‰ã‚’å–ã‚Šã«è¡Œãã€é€Ÿã„ãƒšãƒ¼ã‚¹ã§æ¨ç§»ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚",
            "å‰åŠã‹ã‚‰é£›ã°ã™å±•é–‹ãŒäºˆæƒ³ã•ã‚Œã€å¾ŒåŠã®ã‚¹ã‚¿ãƒŸãƒŠå‹è² ãŒéµã¨ãªã‚Šãã†ã§ã™ã€‚",
            "é€ƒã’é¦¬ãŒè¤‡æ•°ã„ã‚‹ã“ã¨ã‹ã‚‰ã€åºç›¤ã®ãƒã‚¸ã‚·ãƒ§ãƒ³äº‰ã„ãŒæ¿€åŒ–ã—ãã†ã§ã™ã€‚",
        ],
        'ãƒã‚¤ãƒšãƒ¼ã‚¹_effect': [
            "ã“ã®ã‚ˆã†ãªãƒã‚¤ãƒšãƒ¼ã‚¹ã§ã¯ã€å‰åŠã§è„šã‚’ä½¿ã£ãŸé€ƒã’ãƒ»å…ˆè¡Œé¦¬ãŒæœ€å¾Œã®ç›´ç·šã§å¤±é€Ÿã™ã‚‹å¯èƒ½æ€§ãŒé«˜ãã€ä¸­å›£ã‹ã‚‰å¾Œæ–¹ã§è„šã‚’æºœã‚ãŸå·®ã—ãƒ»è¿½è¾¼é¦¬ãŒæœ‰åˆ©ãªå±•é–‹ã¨ãªã‚Šãã†ã§ã™ã€‚",
            "é€Ÿã„ãƒšãƒ¼ã‚¹ã¯å·®ã—ãƒ»è¿½è¾¼é¦¬ã«ã¨ã£ã¦çµ¶å¥½ã®å±•é–‹ã€‚å‰ãŒæ­¢ã¾ã£ãŸã¨ã“ã‚ã‚’ä¸€æ°—ã«å·®ã—åˆ‡ã‚‹å ´é¢ãŒè¦‹ã‚‰ã‚Œãã†ã§ã™ã€‚",
            "å‰åŠã®æ¶ˆè€—æˆ¦ã«ã‚ˆã‚Šã€å¾Œæ–¹å¾…æ©Ÿçµ„ã®æœ«è„šãŒç‚¸è£‚ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚",
            "ã‚¿ãƒ•ãªæµã‚Œã«ãªã‚‹ã“ã¨ã§ã€ã‚¹ã‚¿ãƒŸãƒŠã«å„ªã‚ŒãŸé¦¬ã‚„å±•é–‹åˆ©ã‚’å¾—ã‚‰ã‚Œã‚‹å·®ã—é¦¬ãŒå°é ­ã—ãã†ã§ã™ã€‚",
        ],
        'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_intro': [
            "å„é¦¬ãŒç‰½åˆ¶ã—åˆã„ã€ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ã®å±•é–‹ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚",
            "é€ƒã’é¦¬ãŒå˜é¨ã§æ¥½ã«é€ƒã’ã‚‰ã‚Œãã†ã§ã€å‰åŠã¯ã‚†ã£ãŸã‚Šã¨ã—ãŸãƒšãƒ¼ã‚¹ã«ãªã‚Šãã†ã§ã™ã€‚",
            "åºç›¤ã¯æ§˜å­è¦‹ãƒ ãƒ¼ãƒ‰ã§ã€å¾ŒåŠã®ç¬ç™ºåŠ›å‹è² ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚",
            "å‰åŠã¯å„é¦¬ãŒè„šã‚’æºœã‚åˆã†å±•é–‹ã§ã€æœ€å¾Œã®ç›´ç·šã§ã®ä½ç½®å–ã‚ŠãŒé‡è¦ã«ãªã‚Šãã†ã§ã™ã€‚",
        ],
        'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_effect': [
            "ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ã§ã¯å‰ã«è¡Œã£ãŸé¦¬ãŒæ¥½ã«èµ°ã‚Œã‚‹ãŸã‚ã€é€ƒã’ãƒ»å…ˆè¡Œé¦¬ãŒæœ€å¾Œã¾ã§ç²˜ã‚Šè¾¼ã‚€å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚",
            "å‰æ®‹ã‚Šã®å±•é–‹ãŒäºˆæƒ³ã•ã‚Œã€é€ƒã’ãƒ»å…ˆè¡Œé¦¬ã®ç²˜ã‚Šè¾¼ã¿ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚",
            "æºœã‚ãŸè„šã‚’ä½¿ãˆã‚‹é€ƒã’ãƒ»å…ˆè¡Œé¦¬ãŒæœ‰åˆ©ã§ã€å·®ã—é¦¬ã¯å±Šã‹ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "ç¬ç™ºåŠ›å‹è² ã«ãªã‚Šã‚„ã™ãã€ã‚­ãƒ¬ã®ã‚ã‚‹è„šã‚’æŒã¤é¦¬ãŒæœ‰åˆ©ãªå±•é–‹ã§ã™ã€‚",
        ],
        'å¹³å‡ãƒšãƒ¼ã‚¹_intro': [
            "å¹³å‡çš„ãªãƒšãƒ¼ã‚¹ã§æ¨ç§»ã™ã‚‹ã¨äºˆæƒ³ã•ã‚Œã¾ã™ã€‚",
            "æ¥µç«¯ãªå±•é–‹ã«ã¯ãªã‚Šã«ããã€æ·¡ã€…ã¨ãƒ¬ãƒ¼ã‚¹ãŒé€²ã¿ãã†ã§ã™ã€‚",
            "æ¨™æº–çš„ãªãƒšãƒ¼ã‚¹ãŒäºˆæƒ³ã•ã‚Œã€å„é¦¬ã®åœ°åŠ›ãŒè©¦ã•ã‚Œã‚‹å±•é–‹ã§ã™ã€‚",
            "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸãƒšãƒ¼ã‚¹ã§ã€ã©ã®è„šè³ªã«ã‚‚ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã‚Šãã†ã§ã™ã€‚",
        ],
        'å¹³å‡ãƒšãƒ¼ã‚¹_effect': [
            "æ¥µç«¯ãªå±•é–‹ã«ã¯ãªã‚Šã«ããã€å„é¦¬ã®ç·åˆçš„ãªèƒ½åŠ›ãŒå•ã‚ã‚Œã‚‹çœŸã®å®ŸåŠ›å‹è² ã¨ãªã‚Šãã†ã§ã™ã€‚",
            "ã©ã®è„šè³ªã«ã‚‚å¹³ç­‰ã«ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã‚Šã€èƒ½åŠ›ã¨èª¿å­ã®è‰¯ã„é¦¬ãŒå¥½èµ°ã—ãã†ã§ã™ã€‚",
            "å±•é–‹ã®æœ‰åˆ©ä¸åˆ©ãŒå°‘ãªã„ãŸã‚ã€ç´ ç›´ã«å¼·ã„é¦¬ãŒå‹ã¤å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚",
            "ç·åˆåŠ›ã®é«˜ã„é¦¬ã‚„ã€å®‰å®šæ„Ÿã®ã‚ã‚‹é¦¬ãŒåŠ›ã‚’ç™ºæ®ã—ã‚„ã™ã„å±•é–‹ã§ã™ã€‚",
        ]
    }

def get_horse_description_templates() -> Dict[str, List[str]]:
    """é¦¬ã®èª¬æ˜ã®å¤šæ§˜ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿”ã™"""
    return {
        'é€ƒã’_ç©æ¥µ': [
            "{horse}ã¯è¶…ç©æ¥µçš„ãªé€ƒã’ã‚’è¦‹ã›ã‚‹å¯èƒ½æ€§ãŒé«˜ãã€åºç›¤ã‹ã‚‰å¤§ãããƒªãƒ¼ãƒ‰ã‚’å–ã‚ã†ã¨ã™ã‚‹ã§ã—ã‚‡ã†ã€‚",
            "{horse}ãŒæœæ•¢ã«ãƒãƒŠã‚’å¥ªã„ã«è¡Œãã€å¾Œç¶šã‚’å¤§ããå¼•ãé›¢ã™é€ƒã’ã‚’æ‰“ã¤å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œã‹ã‚‰{horse}ãŒå…ˆé ­ã«ç«‹ã¡ã€ãƒã‚¤ãƒšãƒ¼ã‚¹ã§é€ƒã’ã‚‹å±•é–‹ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚",
            "{horse}ã®ç©æ¥µçš„ãªé€ƒã’ãŒäºˆæƒ³ã•ã‚Œã€ã©ã“ã¾ã§ç²˜ã‚Œã‚‹ã‹ãŒæ³¨ç›®ã•ã‚Œã¾ã™ã€‚",
        ],
        'å…ˆè¡Œ_ç©æ¥µ': [
            "{horses}ã¯ç©æ¥µçš„ã«å‰ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã«è¡Œãã€2-3ç•ªæ‰‹ã§ã®ç«¶é¦¬ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚",
            "{horses}ãŒå¥½ä½ã‚’ç¢ºä¿ã—ã€ç›´ç·šã§å…ˆé ­ã‚’ç‹™ã†ç«¶é¦¬ã‚’ã—ãã†ã§ã™ã€‚",
            "å…ˆè¡ŒåŠ›ã®ã‚ã‚‹{horses}ãŒå‰ã€…ã§ç«¶é¦¬ã‚’é€²ã‚ã€ç²˜ã‚Šå¼·ãèµ°ã‚Šãã†ã§ã™ã€‚",
            "{horses}ã¯ç•ªæ‰‹ã‹ã‚‰è™è¦–çœˆã€…ã¨é€ƒã’é¦¬ã‚’ç‹™ã†ä½ç½®å–ã‚Šã«ãªã‚Šãã†ã§ã™ã€‚",
        ],
        'å·®ã—_æœ‰åˆ©': [
            "ãƒã‚¤ãƒšãƒ¼ã‚¹ãŒäºˆæƒ³ã•ã‚Œã‚‹ä»Šå›ã€{horses}ãªã©ã®å·®ã—é¦¬ã«ã¯çµ¶å¥½ã®å±•é–‹ã¨ãªã‚Šãã†ã§ã™ã€‚",
            "{horses}ã«ã¨ã£ã¦ã¯é¡˜ã£ã¦ã‚‚ãªã„å±•é–‹ã§ã€æœ€å¾Œã®ç›´ç·šã§çˆ†ç™ºçš„ãªæœ«è„šãŒæœŸå¾…ã§ãã¾ã™ã€‚",
            "å±•é–‹ãŒå‘ããã†ãª{horses}ã®æœ«è„šã«æ³¨ç›®ãŒé›†ã¾ã‚Šã¾ã™ã€‚",
            "{horses}ã¯ä¸­å›£å¾…æ©Ÿã‹ã‚‰ã€æœ€å¾Œã®ç›´ç·šã§é‹­ã„è„šã‚’ä½¿ã£ã¦ããã†ã§ã™ã€‚",
        ],
        'è¿½è¾¼_æœŸå¾…': [
            "{horses}ãªã©ã®è¿½è¾¼é¦¬ã‚‚ã€å‰ãŒãƒãƒ†ã‚‹å±•é–‹ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚",
            "æœ€å¾Œæ–¹ã‹ã‚‰ä¸€æ°—ã®è¿½è¾¼ã‚’ç‹™ã†{horses}ã®æœ«è„šæ¬¡ç¬¬ã§ã¯æ¿€èµ°ã‚‚ã‚ã‚Šãˆã¾ã™ã€‚",
            "{horses}ã¯å¾Œæ–¹ä¸€æ°—ã®æˆ¦æ³•ã§ã€ç›´ç·šã§ã®è±ªè„šã«æœŸå¾…ãŒã‹ã‹ã‚Šã¾ã™ã€‚",
            "å±•é–‹æ¬¡ç¬¬ã§ã¯{horses}ã®å¼·çƒˆãªè¿½è¾¼ãŒç‚¸è£‚ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
        ]
    }

def get_conclusion_templates() -> Dict[str, List[str]]:
    """çµè«–éƒ¨åˆ†ã®å¤šæ§˜ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿”ã™"""
    return {
        'ãƒã‚¤ãƒšãƒ¼ã‚¹': [
            "ãƒã‚¤ãƒšãƒ¼ã‚¹ã®æ¶ˆè€—æˆ¦ãŒäºˆæƒ³ã•ã‚Œã€å¾Œæ–¹å¾…æ©Ÿçµ„ã®å°é ­ã«æœŸå¾…ãŒæŒã¦ã‚‹å±•é–‹ã§ã™ã€‚",
            "å‰åŠã®æ¿€ã—ã„æµã‚ŒãŒã€å¾ŒåŠã®å¤§ããªå±•é–‹å¤‰åŒ–ã‚’ç”Ÿã¿ãã†ã§ã™ã€‚",
            "ã‚¹ã‚¿ãƒŸãƒŠã¨æœ«è„šã®ä¸¡æ–¹ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€ã‚¿ãƒ•ãªãƒ¬ãƒ¼ã‚¹ã«ãªã‚Šãã†ã§ã™ã€‚",
            "å·®ã—ãƒ»è¿½è¾¼é¦¬ã«ã¨ã£ã¦çµ¶å¥½ã®å±•é–‹ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚",
        ],
        'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹': [
            "å‰æ®‹ã‚Šã®å¯èƒ½æ€§ãŒé«˜ãã€é€ƒã’ãƒ»å…ˆè¡Œé¦¬ã‚’ä¸­å¿ƒã¨ã—ãŸé¦¬åˆ¸ãŒé¢ç™½ãã†ã§ã™ã€‚",
            "ç¬ç™ºåŠ›å‹è² ã«ãªã‚Šã‚„ã™ãã€ã‚­ãƒ¬ã®ã‚ã‚‹è„šã‚’æŒã¤é¦¬ã«æ³¨ç›®ã§ã™ã€‚",
            "å‰ã«è¡Œã£ãŸé¦¬ãŒæœ‰åˆ©ãªå±•é–‹ã§ã€å…ˆè¡ŒåŠ›ã®ã‚ã‚‹é¦¬ã‚’é‡è¦–ã—ãŸã„ã§ã™ã€‚",
            "ã‚¹ãƒ­ãƒ¼ã®ç¬ç™ºåŠ›å‹è² ã§ã¯ã€ä½ç½®å–ã‚Šã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé‡è¦ã«ãªã‚Šãã†ã§ã™ã€‚",
        ],
        'å¹³å‡ãƒšãƒ¼ã‚¹': [
            "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå±•é–‹ã§ã€ç·åˆåŠ›ã®é«˜ã„é¦¬ãŒç´ ç›´ã«å¥½èµ°ã—ãã†ã§ã™ã€‚",
            "å±•é–‹ã®æœ‰åˆ©ä¸åˆ©ãŒå°‘ãªãã€å®ŸåŠ›é€šã‚Šã®çµæœã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚",
            "ã©ã®è„šè³ªã«ã‚‚ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã‚Šã€èª¿å­ã®è‰¯ã„é¦¬ã‚’è¦‹æ¥µã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚",
            "å®‰å®šæ„Ÿã®ã‚ã‚‹é¦¬ã‚„ã€ã“ã®ã‚³ãƒ¼ã‚¹ã§å®Ÿç¸¾ã®ã‚ã‚‹é¦¬ãŒç‹™ã„ç›®ã§ã™ã€‚",
        ]
    }

def format_flow_prediction_advanced(result: Dict[str, Any]) -> str:
    """é«˜åº¦ãªå±•é–‹äºˆæƒ³çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ - é•·æ–‡ã®è‡ªç„¶è¨€èªã§å‡ºåŠ›"""
    lines = []
    lines.append("## ğŸ‡ **ViewLogicå±•é–‹äºˆæƒ³**")
    lines.append("")
    
    # ãƒ¬ãƒ¼ã‚¹æƒ…å ±
    race_info = result.get('race_info', {})
    venue = race_info.get('venue', '')
    race_number = race_info.get('race_number', '')
    distance = race_info.get('distance', '')
    
    lines.append(f"### {venue} {race_number}R - {race_info.get('race_name', '')}")
    lines.append(f"**è·é›¢**: {distance}")
    lines.append("")
    
    # ã‚³ãƒ¼ã‚¹ç‰¹æ€§ã®èª¬æ˜ï¼ˆè·é›¢ã¨é–‹å‚¬å ´ã«å¿œã˜ãŸè§£èª¬ï¼‰
    lines.append("### ãƒ¬ãƒ¼ã‚¹å±•é–‹ã®è¦‹é€šã—")
    lines.append("")
    
    # é–‹å‚¬å ´åˆ¥ã®ã‚³ãƒ¼ã‚¹ç‰¹æ€§èª¬æ˜
    if venue == "æ–°æ½Ÿ":
        if "1800" in str(distance):
            lines.append(f"æ–°æ½Ÿ{distance}ã¯ç›´ç·šãŒé•·ãã€æœ€å¾Œã®ç›´ç·šã§ã®ç¬ç™ºåŠ›å‹è² ã«ãªã‚Šã‚„ã™ã„ã‚³ãƒ¼ã‚¹ã§ã™ã€‚å¤–å›ã‚Šã‚³ãƒ¼ã‚¹ã®ãŸã‚ã€")
            lines.append("ã‚¹ã‚¿ãƒ¼ãƒˆå¾Œã®ãƒã‚¸ã‚·ãƒ§ãƒ³å–ã‚ŠãŒé‡è¦ã§ã€ä¸­å›£ã‹ã‚‰å¾Œæ–¹ã§è„šã‚’æºœã‚ãŸé¦¬ã®å°é ­ãŒæœŸå¾…ã§ãã¾ã™ã€‚")
        elif "1000" in str(distance):
            lines.append(f"æ–°æ½Ÿ{distance}ç›´ç·šã¯æ—¥æœ¬æœ€çŸ­è·é›¢ã®ç›´ç·šç«¶é¦¬ã§ã™ã€‚ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ã¨ç¬ç™ºåŠ›ãŒå…¨ã¦ã‚’æ±ºã‚ã‚‹ç‰¹æ®Šãªãƒ¬ãƒ¼ã‚¹ã¨ãªã‚Šã¾ã™ã€‚")
        else:
            lines.append(f"{venue}{distance}ã¯ã€ç›´ç·šã®é•·ã„æ–°æ½Ÿç«¶é¦¬å ´ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ãŸå±•é–‹ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚")
    elif venue == "æ±äº¬":
        lines.append(f"æ±äº¬{distance}ã¯ç›´ç·šãŒé•·ãã€æœ€å¾Œã®ç›´ç·šã§ã®ç¬ç™ºåŠ›ã¨æŒç¶šåŠ›ãŒå•ã‚ã‚Œã‚‹ã‚³ãƒ¼ã‚¹ã§ã™ã€‚")
        lines.append("åºƒã„ã‚³ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãŸã‚ã€å¤–ã‚’å›ã£ã¦ã‚‚ä¸åˆ©ãŒå°‘ãªãã€å¾Œæ–¹ã‹ã‚‰ã®è¿½ã„è¾¼ã¿ã‚‚æ±ºã¾ã‚Šã‚„ã™ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
    elif venue == "ä¸­å±±":
        lines.append(f"ä¸­å±±{distance}ã¯æ€¥å‚ã¨å°å›ã‚ŠãŒç‰¹å¾´çš„ãªã‚³ãƒ¼ã‚¹ã§ã™ã€‚å…ˆè¡ŒåŠ›ã¨å™¨ç”¨ã•ãŒæ±‚ã‚ã‚‰ã‚Œã€")
        lines.append("é€ƒã’ãƒ»å…ˆè¡Œé¦¬ãŒç²˜ã‚Šè¾¼ã¿ã‚„ã™ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
    else:
        lines.append(f"{venue}{distance}ã®å±•é–‹ã‚’åˆ†æã—ã¾ã™ã€‚")
    lines.append("")
    
    # ãƒšãƒ¼ã‚¹äºˆæƒ³ã®è©³ç´°èª¬æ˜
    pace_pred = result.get('pace_prediction', {})
    pace = pace_pred.get('pace', 'ä¸æ˜')
    confidence = pace_pred.get('confidence', 0)
    zenhan_avg = pace_pred.get('zenhan_avg', 0)
    kohan_avg = pace_pred.get('kohan_avg', 0)
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
    import logging
    logger = logging.getLogger(__name__)
    logger.info(f"ViewLogicå±•é–‹äºˆæƒ³ - zenhan_avg: {zenhan_avg}, kohan_avg: {kohan_avg}, pace: {pace}")
    
    # ãƒšãƒ¼ã‚¹äºˆæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºåŒ–ï¼ˆã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹äºˆæƒ³ãŒå¤šã„ãŸã‚ï¼‰
    # lines.append("### ãƒšãƒ¼ã‚¹äºˆæƒ³")
    # lines.append("")
    # lines.append(f"**äºˆæƒ³ãƒšãƒ¼ã‚¹: {pace}** ï¼ˆç¢ºä¿¡åº¦: {confidence}%ï¼‰")
    # lines.append("")
    # 
    # # ãƒšãƒ¼ã‚¹ã«å¿œã˜ãŸè©³ç´°ãªè§£èª¬
    # templates = get_pace_templates()
    # 
    # # zenhan_avgãŒç•°å¸¸ã«å°ã•ã„å ´åˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰ã¯åˆ¥ã®è¡¨ç¾ã‚’ä½¿ç”¨
    # if zenhan_avg < 20:  # 20ç§’æœªæº€ã¯ç‰©ç†çš„ã«ä¸å¯èƒ½
    #     # ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®æ±ç”¨çš„ãªè¡¨ç¾
    #     if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
    #         lines.append(random.choice(templates['ãƒã‚¤ãƒšãƒ¼ã‚¹_intro']))
    #     elif 'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹' in pace:
    #         lines.append(random.choice(templates['ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_intro']))
    #     else:
    #         lines.append(random.choice(templates['å¹³å‡ãƒšãƒ¼ã‚¹_intro']))
    # elif 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
    #     lines.append(f"å‰åŠã¯é€Ÿã„ãƒšãƒ¼ã‚¹ã§æ¨ç§»ã—ã€{random.choice(templates['ãƒã‚¤ãƒšãƒ¼ã‚¹_intro'])}")
    #     lines.append(random.choice(templates['ãƒã‚¤ãƒšãƒ¼ã‚¹_effect']))
    #     lines.append("å¾ŒåŠã¯å‰åŠã®ãƒšãƒ¼ã‚¹åå‹•ã§å¤±é€ŸãŒæ‡¸å¿µã•ã‚Œã‚‹å±•é–‹ã§ã™ã€‚")
    # elif 'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹' in pace:
    #     if zenhan_avg >= 20:  # æ­£å¸¸ãªå€¤ã®å ´åˆã®ã¿æŠ½è±¡è¡¨ç¾ã‚’ä½¿ç”¨
    #         lines.append(f"å‰åŠã¯é…ã‚ã®ãƒšãƒ¼ã‚¹ã§ã€{random.choice(templates['ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_intro'])}")
    #         lines.append(random.choice(templates['ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_effect']))
    #         lines.append("å¾ŒåŠã¯ç¬ç™ºåŠ›å‹è² ã«ãªã‚Šãã†ã§ã™ãŒã€å‰æ®‹ã‚Šã®å¯èƒ½æ€§ãŒé«˜ã„å±•é–‹ã§ã™ã€‚")
    #     else:
    #         lines.append(random.choice(templates['ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_intro']))
    #         lines.append(random.choice(templates['ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹_effect']))
    # else:
    #     if zenhan_avg >= 20:  # æ­£å¸¸ãªå€¤ã®å ´åˆã®ã¿æŠ½è±¡è¡¨ç¾ã‚’ä½¿ç”¨
    #         lines.append(f"å‰åŠãƒ»å¾ŒåŠã¨ã‚‚ã«æ¨™æº–çš„ãªãƒšãƒ¼ã‚¹ã§ã€{random.choice(templates['å¹³å‡ãƒšãƒ¼ã‚¹_intro'])}")
    #         lines.append(random.choice(templates['å¹³å‡ãƒšãƒ¼ã‚¹_effect']))
    #     else:
    #         lines.append(random.choice(templates['å¹³å‡ãƒšãƒ¼ã‚¹_intro']))
    #         lines.append(random.choice(templates['å¹³å‡ãƒšãƒ¼ã‚¹_effect']))
    # lines.append("")
    
    # è„šè³ªåˆ¥ã®é¦¬åæ•´ç†ï¼ˆé¦¬ç•ªé †ï¼‰
    detailed_styles = result.get('detailed_styles', {})

    # å„è„šè³ªã®é¦¬ã‚’é¦¬ç•ªé †ã«æ•´ç†
    nige_horses = []
    senko_horses = []
    sashi_horses = []
    oikomi_horses = []

    # é¦¬ç•ªæƒ…å ±ã‚’å–å¾—ã—ã¦ã‚½ãƒ¼ãƒˆç”¨ã«ä½¿ç”¨
    horses_data = result.get('horses_data', [])
    horse_to_number = {}
    for horse_data in horses_data:
        if isinstance(horse_data, dict):
            horse_name = horse_data.get('horse_name', '')
            horse_number = horse_data.get('horse_number', 999)  # é¦¬ç•ªãŒãªã„å ´åˆã¯999
            if horse_name:
                horse_to_number[horse_name] = horse_number

    # å„è„šè³ªã®é¦¬ã‚’åé›†
    if 'é€ƒã’' in detailed_styles:
        for sub_style, horses in detailed_styles['é€ƒã’'].items():
            if horses:
                nige_horses.extend(horses)

    if 'å…ˆè¡Œ' in detailed_styles:
        for sub_style, horses in detailed_styles['å…ˆè¡Œ'].items():
            if horses:
                senko_horses.extend(horses)

    if 'å·®ã—' in detailed_styles:
        for sub_style, horses in detailed_styles['å·®ã—'].items():
            if horses:
                sashi_horses.extend(horses)

    if 'è¿½è¾¼' in detailed_styles:
        for sub_style, horses in detailed_styles['è¿½è¾¼'].items():
            if horses:
                oikomi_horses.extend(horses)

    # é¦¬ç•ªé †ã«ã‚½ãƒ¼ãƒˆ
    nige_horses = sorted(nige_horses, key=lambda x: horse_to_number.get(x, 999))
    senko_horses = sorted(senko_horses, key=lambda x: horse_to_number.get(x, 999))
    sashi_horses = sorted(sashi_horses, key=lambda x: horse_to_number.get(x, 999))
    oikomi_horses = sorted(oikomi_horses, key=lambda x: horse_to_number.get(x, 999))

    # è„šè³ªåˆ¥é¦¬åã‚’è‡ªç„¶ãªæ–‡ç« ã«çµ„ã¿è¾¼ã‚€
    lines.append("### å±•é–‹äºˆæƒ³ã®è©³ç´°åˆ†æ")
    lines.append("")

    # ãƒšãƒ¼ã‚¹å±•é–‹ã¨è„šè³ªæ§‹æˆã®èª¬æ˜
    if nige_horses or senko_horses:
        lines.append("#### å‰åŠã®éšŠåˆ—å½¢æˆ")
        if nige_horses:
            if len(nige_horses) == 1:
                lines.append(f"ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰**{nige_horses[0]}**ãŒå˜é¨ã§é€ƒã’ã‚’æ‰“ã¤å±•é–‹ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚")
            else:
                lines.append(f"é€ƒã’ã‚’ç‹™ã†ã®ã¯**{', '.join(nige_horses)}**ã§ã€åºç›¤ã®ä¸»å°æ¨©äº‰ã„ãŒæ³¨ç›®ã•ã‚Œã¾ã™ã€‚")

        if senko_horses:
            if len(senko_horses) <= 3:
                lines.append(f"å…ˆè¡Œå‹¢ã¨ã—ã¦**{', '.join(senko_horses)}**ãŒå¥½ä½ã‚’ç¢ºä¿ã—ã€é€ƒã’é¦¬ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹å½¢ã«ãªã‚Šãã†ã§ã™ã€‚")
            else:
                lines.append(f"å…ˆè¡Œå‹¢ã¯**{', '.join(senko_horses[:3])}**ã‚’ä¸­å¿ƒã«ã€{'ã€'.join(senko_horses[3:])}ã‚‚å‰ç›®ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã«è¡Œããã†ã§ã™ã€‚")
        lines.append("")

    # ä¸­å›£ã‹ã‚‰å¾Œæ–¹ã®é¦¬
    if sashi_horses or oikomi_horses:
        lines.append("#### ä¸­å›£ã‹ã‚‰å¾Œæ–¹ã®å¸ƒé™£")
        if sashi_horses:
            if len(sashi_horses) <= 3:
                lines.append(f"ä¸­å›£å¾…æ©Ÿçµ„ã®**{', '.join(sashi_horses)}**ã¯ã€å‰åŠã¯è„šã‚’æºœã‚ã¦ç›´ç·šã§ã®å·®ã—è„šã«è³­ã‘ã¾ã™ã€‚")
            else:
                lines.append(f"å·®ã—é¦¬ã¯**{', '.join(sashi_horses[:3])}**ãŒä¸­å¿ƒã¨ãªã‚Šã€{'ã€'.join(sashi_horses[3:])}ã‚‚ä¸­å›£ã‹ã‚‰è™è¦–çœˆã€…ã¨ä¸Šä½ã‚’ç‹™ã„ã¾ã™ã€‚")

        if oikomi_horses:
            if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
                lines.append(f"å¾Œæ–¹ã‹ã‚‰è¿½ã„è¾¼ã¿ã‚’ç‹™ã†**{', '.join(oikomi_horses)}**ã«ã¨ã£ã¦ã¯ã€ãƒšãƒ¼ã‚¹ãŒé€Ÿããªã‚‹ã“ã¨ã§å±•é–‹åˆ©ãŒç”Ÿã¾ã‚Œãã†ã§ã™ã€‚")
            else:
                lines.append(f"è¿½ã„è¾¼ã¿å‹¢ã®**{', '.join(oikomi_horses)}**ã¯å¾Œæ–¹å¾…æ©Ÿã¨ãªã‚Šã¾ã™ãŒã€å±•é–‹ä¸€ã¤ã§æ¿€èµ°ã®å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚")
        lines.append("")

    # ãƒšãƒ¼ã‚¹ã¨è„šè³ªã®ç›¸æ€§åˆ†æ
    lines.append("#### å±•é–‹äºˆæƒ³ã®ãƒã‚¤ãƒ³ãƒˆ")
    # ãƒšãƒ¼ã‚¹äºˆæƒ³ã®æ–‡è¨€ã‚’å‰Šé™¤ã—ã€é¦¬ã®å±•é–‹åˆ†æã®ã¿ã‚’æ®‹ã™
    # if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
    #     if nige_horses or senko_horses:
    #         lines.append(f"ãƒã‚¤ãƒšãƒ¼ã‚¹ãŒäºˆæƒ³ã•ã‚Œã‚‹ä¸­ã€é€ƒã’ãƒ»å…ˆè¡Œå‹¢ã®{'ã€'.join(nige_horses[:2] + senko_horses[:2])}ã¯åºç›¤ã‹ã‚‰å³ã—ã„æµã‚Œã«å·»ãè¾¼ã¾ã‚Œãã†ã§ã™ã€‚")
    #     if sashi_horses or oikomi_horses:
    #         lines.append(f"ã“ã®å±•é–‹ã¯å·®ã—ãƒ»è¿½è¾¼é¦¬ã®{'ã€'.join(sashi_horses[:2] + oikomi_horses[:1])}ã«ã¨ã£ã¦çµ¶å¥½ã®å±•é–‹ã¨ãªã‚Šã€ç›´ç·šã§ã®æœ«è„šå‹è² ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚")
    # elif 'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹' in pace:
    #     if nige_horses:
    #         lines.append(f"ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ãŒäºˆæƒ³ã•ã‚Œã‚‹ä¸­ã€é€ƒã’é¦¬ã®**{nige_horses[0]}**ã¯æ¥½ã«é€ƒã’ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ãã€ç²˜ã‚Šè¾¼ã¿ãŒæœŸå¾…ã§ãã¾ã™ã€‚")
    #     if senko_horses:
    #         lines.append(f"å…ˆè¡Œå‹¢ã®{'ã€'.join(senko_horses[:3])}ã‚‚å‰åŠã§è„šã‚’ä½¿ã‚ãšã«æ¸ˆã‚€ãŸã‚ã€ç›´ç·šã§ã‚‚ã—ã£ã‹ã‚Šã¨ã—ãŸè„šã‚’ä½¿ãˆãã†ã§ã™ã€‚")
    # else:
    #     lines.append("ãƒŸãƒ‰ãƒ«ãƒšãƒ¼ã‚¹ã§ã®æµã‚Œã¨ãªã‚Šãã†ã§ã€å„é¦¬ã®åœ°åŠ›ãŒè©¦ã•ã‚Œã‚‹å±•é–‹ã«ãªã‚Šãã†ã§ã™ã€‚")
    #     if senko_horses:
    #         lines.append(f"ã“ã®ãƒšãƒ¼ã‚¹ã¯å…ˆè¡Œé¦¬ã®{'ã€'.join(senko_horses[:3])}ã«ã¨ã£ã¦ç†æƒ³çš„ã§ã€æŒã¡å‘³ã‚’ç™ºæ®ã—ã‚„ã™ã„æµã‚Œã¨ãªã‚Šãã†ã§ã™ã€‚")
    
    # ãƒšãƒ¼ã‚¹ã«ä¾å­˜ã—ãªã„å±•é–‹äºˆæƒ³ã®åˆ†æ
    if nige_horses:
        lines.append(f"é€ƒã’é¦¬ã®**{nige_horses[0]}**ãŒã©ã®ã‚ˆã†ãªãƒšãƒ¼ã‚¹ã‚’åˆ»ã‚€ã‹ãŒå±•é–‹ã®éµã¨ãªã‚Šãã†ã§ã™ã€‚")
    if senko_horses:
        lines.append(f"å…ˆè¡Œå‹¢ã®{'ã€'.join(senko_horses[:3])}ã®ä½ç½®å–ã‚ŠãŒé‡è¦ã«ãªã£ã¦ãã¾ã™ã€‚")
    if sashi_horses or oikomi_horses:
        lines.append(f"å·®ã—ãƒ»è¿½è¾¼é¦¬ã®{'ã€'.join(sashi_horses[:2] + oikomi_horses[:1])}ã¯ã€ç›´ç·šã§ã®æœ«è„šå‹è² ã«æŒã¡è¾¼ã¿ãŸã„ã¨ã“ã‚ã§ã™ã€‚")

    lines.append("")

    # ãƒ¬ãƒ¼ã‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°
    simulation = result.get('race_simulation', {})
    if simulation:
        lines.append("### å±•é–‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
        lines.append("")
        
        # ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰åºç›¤ã®å±•é–‹
        if 'start' in simulation and len(simulation['start']) > 0:
            start_horses = [entry.get('horse_name', 'ä¸æ˜') for entry in simulation['start'][:3]]
            lines.append("#### ã‚¹ã‚¿ãƒ¼ãƒˆã€œåºç›¤")
            lines.append(f"ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œã¯**{start_horses[0]}**ãŒç©æ¥µçš„ã«ãƒãƒŠã‚’ä¸»å¼µã—ã€")
            if len(start_horses) > 1:
                lines.append(f"**{start_horses[1]}**ãŒãã‚Œã«ç¶šãå½¢ã«ãªã‚Šãã†ã§ã™ã€‚")
            lines.append("")
        
        # ä¸­ç›¤ã®å±•é–‹
        if 'corner3' in simulation and len(simulation['corner3']) > 0:
            corner3_horses = [entry.get('horse_name', 'ä¸æ˜') for entry in simulation['corner3'][:5]]
            lines.append("#### ä¸­ç›¤ã®å±•é–‹ï¼ˆ3ã‚³ãƒ¼ãƒŠãƒ¼ä»˜è¿‘ï¼‰")
            if len(corner3_horses) >= 1:
                lines.append(f"3ã‚³ãƒ¼ãƒŠãƒ¼ã‚’è¿ãˆã‚‹é ƒã«ã¯ã€**{corner3_horses[0]}**ãŒãƒªãƒ¼ãƒ‰ã‚’ä¿ã¡ã€")
            if len(corner3_horses) >= 3:
                lines.append(f"2ç•ªæ‰‹ã«**{corner3_horses[1]}**ã€3ç•ªæ‰‹ã«**{corner3_horses[2]}**ã¨ã„ã†éšŠåˆ—ã«ãªã‚Šãã†ã§ã™ã€‚")
            elif len(corner3_horses) >= 2:
                lines.append(f"2ç•ªæ‰‹ã«**{corner3_horses[1]}**ãŒç¶šãå±•é–‹ã«ãªã‚Šãã†ã§ã™ã€‚")
            if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
                lines.append("ãƒšãƒ¼ã‚¹ãŒé€Ÿã„ãŸã‚ã€å¾Œæ–¹å¾…æ©Ÿçµ„ãŒå¾ã€…ã«é€²å‡ºã‚’é–‹å§‹ã™ã‚‹å ´é¢ã§ã™ã€‚")
            lines.append("")
        
        # çµ‚ç›¤ã®å±•é–‹
        if 'corner4' in simulation and len(simulation['corner4']) > 0:
            corner4_horses = [entry.get('horse_name', 'ä¸æ˜') for entry in simulation['corner4'][:5]]
            lines.append("#### å‹è² æ‰€ï¼ˆ4ã‚³ãƒ¼ãƒŠãƒ¼ï¼‰")
            if len(corner4_horses) >= 1:
                lines.append(f"æœ€å¾Œã®4ã‚³ãƒ¼ãƒŠãƒ¼ã§ã¯ã€**{corner4_horses[0]}**ãŒä¾ç„¶ã¨ã—ã¦å…ˆé ­ã‚’ã‚­ãƒ¼ãƒ—ã—ã¦ã„ã¾ã™ãŒã€")
            if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
                lines.append("ãƒã‚¤ãƒšãƒ¼ã‚¹ã®å½±éŸ¿ã§è„šè‰²ãŒéˆã‚Šå§‹ã‚ã€å¾Œç¶šã®å·®ã—ãƒ»è¿½è¾¼é¦¬ãŒä¸€æ°—ã«æ¥è¿‘ã—ã¦ãã¾ã™ã€‚")
                if len(corner4_horses) >= 4:
                    lines.append(f"ç‰¹ã«**{corner4_horses[2]}**ã‚„**{corner4_horses[3]}**ã®æœ«è„šãŒæ³¨ç›®ã•ã‚Œã¾ã™ã€‚")
                elif len(corner4_horses) >= 3:
                    lines.append(f"ç‰¹ã«**{corner4_horses[2]}**ã®æœ«è„šãŒæ³¨ç›®ã•ã‚Œã¾ã™ã€‚")
            else:
                if len(corner4_horses) >= 3:
                    lines.append(f"**{corner4_horses[1]}**ã¨**{corner4_horses[2]}**ãŒè™è¦–çœˆã€…ã¨é€†è»¢ã‚’ç‹™ã£ã¦ã„ã¾ã™ã€‚")
                elif len(corner4_horses) >= 2:
                    lines.append(f"**{corner4_horses[1]}**ãŒè™è¦–çœˆã€…ã¨é€†è»¢ã‚’ç‹™ã£ã¦ã„ã¾ã™ã€‚")
            lines.append("")
        
        # ã‚´ãƒ¼ãƒ«äºˆæƒ³ï¼ˆä¸Šä½5é ­ã®è¡¨ç¤ºã‚’å‰Šé™¤ã—ã€å±•é–‹ã®æµã‚Œã¨ã—ã¦è¨˜è¿°ï¼‰
        if 'finish' in simulation and len(simulation['finish']) > 0:
            finish_horses = [entry.get('horse_name', 'ä¸æ˜') for entry in simulation['finish'][:5]]
            lines.append("#### ã‚´ãƒ¼ãƒ«å‰ã®æ”»é˜²")

            # å±•é–‹ã‚’è‡ªç„¶ãªæ–‡ç« ã§è¡¨ç¾ï¼ˆé †ä½ã¯æ˜ç¤ºã—ãªã„ï¼‰
            if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
                lines.append("ãƒã‚¤ãƒšãƒ¼ã‚¹ã®æµã‚Œã‚’æ´»ã‹ã—ã¦ã€å¾Œæ–¹å¾…æ©Ÿçµ„ãŒä¸€æ°—ã«å·®ã—åˆ‡ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
                if len(finish_horses) >= 3:
                    lines.append(f"ç‰¹ã«**{finish_horses[0]}**ã€**{finish_horses[1]}**ã€**{finish_horses[2]}**ã‚ãŸã‚Šã®æœ«è„šãŒæ³¨ç›®ã•ã‚Œã¾ã™ã€‚")
            elif 'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹' in pace:
                lines.append("ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ã‹ã‚‰ã®ç¬ç™ºåŠ›å‹è² ã¨ãªã‚Šã€å‰æ®‹ã‚Šã®å¯èƒ½æ€§ã‚‚ååˆ†ã«ã‚ã‚Šã¾ã™ã€‚")
                if len(finish_horses) >= 2:
                    lines.append(f"**{finish_horses[0]}**ã¨**{finish_horses[1]}**ã®å©ãåˆã„ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚")
            else:
                lines.append("ãƒŸãƒ‰ãƒ«ãƒšãƒ¼ã‚¹ã§ã®ç·åˆåŠ›å‹è² ã¨ãªã‚Šãã†ã§ã™ã€‚")
                if len(finish_horses) >= 3:
                    lines.append(f"**{finish_horses[0]}**ã‚’ä¸­å¿ƒã«ã€**{finish_horses[1]}**ã€**{finish_horses[2]}**ãŒæœ‰åŠ›å€™è£œã¨ãªã‚Šãã†ã§ã™ã€‚")
        lines.append("")
    
    # æœ€çµ‚çš„ãªç‹™ã„ç›®ã¨æ¨å¥¨
    lines.append("### ğŸ¯ æœ€çµ‚äºˆæƒ³ã¨ç‹™ã„ç›®")
    lines.append("")
    
    # ãƒšãƒ¼ã‚¹äºˆæƒ³ä¾å­˜ã®ç‹™ã„ç›®ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    # if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
    #     lines.append("#### ãƒã‚¤ãƒšãƒ¼ã‚¹ã‚’æ´»ã‹ã™ç‹™ã„æ–¹")
    #     lines.append("ä»Šå›ã®ãƒ¬ãƒ¼ã‚¹ã¯**ãƒã‚¤ãƒšãƒ¼ã‚¹ãŒäºˆæƒ³ã•ã‚Œã‚‹**ãŸã‚ã€ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦ãã ã•ã„ï¼š")
    #     lines.append("")
    #     lines.append("1. **å¾Œæ–¹å¾…æ©Ÿã®å·®ã—ãƒ»è¿½è¾¼é¦¬ã‚’é‡è¦–**")
    #     lines.append("   å‰åŠã®ãƒã‚¤ãƒšãƒ¼ã‚¹ã§å‰ã®é¦¬ãŒã‚¹ã‚¿ãƒŸãƒŠã‚’æ¶ˆè€—ã™ã‚‹ãŸã‚ã€æœ€å¾Œã®ç›´ç·šã§å·®ã—ãƒ»è¿½è¾¼é¦¬ã®ä¸€ç™ºãŒã‚ã‚Šã¾ã™ã€‚")
    #     lines.append("")
    #     lines.append("2. **å‰åŠé£›ã°ã™é€ƒã’ãƒ»å…ˆè¡Œé¦¬ã¯å‰²å¼•**")
    #     lines.append("   åºç›¤ã‹ã‚‰é€Ÿã„ãƒšãƒ¼ã‚¹ã«å·»ãè¾¼ã¾ã‚Œã‚‹é€ƒã’ãƒ»å…ˆè¡Œé¦¬ã¯ã€æœ€å¾Œã¾ã§æŒãŸãªã„å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚")
    #     lines.append("")
    #     lines.append("3. **ã‚¹ã‚¿ãƒŸãƒŠã¨æœ«è„šã®ä¸¡ç«‹**")
    #     lines.append("   ãƒã‚¤ãƒšãƒ¼ã‚¹ã«å¯¾å¿œã§ãã‚‹ã‚¹ã‚¿ãƒŸãƒŠã¨ã€æœ€å¾Œã«ä¼¸ã³ã‚‹æœ«è„šã‚’æŒã¤é¦¬ãŒç†æƒ³çš„ã§ã™ã€‚")
    #     
    # elif 'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹' in pace:
    #     lines.append("#### ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ã§ã®å‰æ®‹ã‚Šç‹™ã„")
    #     lines.append("ä»Šå›ã¯**ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ãŒäºˆæƒ³ã•ã‚Œã‚‹**ãŸã‚ã€ä»¥ä¸‹ã®æˆ¦ç•¥ãŒæœ‰åŠ¹ã§ã™ï¼š")
    #     lines.append("")
    #     lines.append("1. **å‰æ®‹ã‚Šã®å¯èƒ½æ€§å¤§**")
    #     lines.append("   æ¥½ãªãƒšãƒ¼ã‚¹ã§é€ƒã’ãƒ»å…ˆè¡Œã§ãã‚‹é¦¬ã¯ã€æœ€å¾Œã¾ã§ä½™åŠ›ã‚’æ®‹ã—ã¦ç²˜ã‚Šè¾¼ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
    #     lines.append("")
    #     lines.append("2. **é€ƒã’ãƒ»å…ˆè¡Œé¦¬ã‚’é‡è¦–**")
    #     lines.append("   ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ã§ã¯å‰ã«è¡Œã£ãŸé¦¬ãŒæœ‰åˆ©ã€‚ç‰¹ã«é€ƒã’é¦¬ã®é€ƒã’åˆ‡ã‚Šã‚‚ååˆ†ã‚ã‚Šå¾—ã¾ã™ã€‚")
    #     lines.append("")
    #     lines.append("3. **è¿½è¾¼ä¸€è¾ºå€’ã¯å±é™º**")
    #     lines.append("   å‰ãŒæ­¢ã¾ã‚‰ãªã„å±•é–‹ã§ã¯ã€å¾Œæ–¹ã‹ã‚‰ã®è¿½è¾¼é¦¬ã¯å±Šã‹ãªã„ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚")
    #     
    # else:
    #     lines.append("#### å¹³å‡ãƒšãƒ¼ã‚¹ã§ã®å®ŸåŠ›å‹è² ")
    #     lines.append("ä»Šå›ã¯**å¹³å‡çš„ãªãƒšãƒ¼ã‚¹**ãŒäºˆæƒ³ã•ã‚Œã‚‹ãŸã‚ã€ç·åˆåŠ›ãŒå•ã‚ã‚Œã¾ã™ï¼š")
    #     lines.append("")
    #     lines.append("1. **ç·åˆåŠ›ã®é«˜ã„é¦¬ã‚’é‡è¦–**")
    #     lines.append("   æ¥µç«¯ãªå±•é–‹ã«ãªã‚‰ãªã„ãŸã‚ã€èƒ½åŠ›ã®é«˜ã„é¦¬ãŒç´ ç›´ã«å¥½èµ°ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚")
    #     lines.append("")
    #     lines.append("2. **å™¨ç”¨ã•ã¨å¯¾å¿œåŠ›**")
    #     lines.append("   ã©ã‚“ãªå±•é–‹ã«ã‚‚å¯¾å¿œã§ãã‚‹å™¨ç”¨ãªé¦¬ãŒæœ‰åˆ©ã§ã™ã€‚")
    #     lines.append("")
    #     lines.append("3. **å®Ÿç¸¾ã¨å®‰å®šæ„Ÿ**")
    #     lines.append("   éå»ã®å®Ÿç¸¾ãŒå®‰å®šã—ã¦ã„ã‚‹é¦¬ã‚’ä¿¡é ¼ã§ãã‚‹å±•é–‹ã§ã™ã€‚")
    
    # ãƒšãƒ¼ã‚¹ã«ä¾å­˜ã—ãªã„ç‹™ã„ç›®ã®åˆ†æ
    lines.append("#### ãƒ¬ãƒ¼ã‚¹å±•é–‹ã‚’è¸ã¾ãˆãŸç‹™ã„ç›®")
    lines.append("ä»Šå›ã®ãƒ¬ãƒ¼ã‚¹ã§ã¯ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦ãã ã•ã„ï¼š")
    lines.append("")
    lines.append("1. **è„šè³ªã®ãƒãƒ©ãƒ³ã‚¹**")
    lines.append("   å„é¦¬ã®è„šè³ªã¨å±•é–‹é©æ€§ã‚’è€ƒæ…®ã—ã¦ã€æœ‰åˆ©ãªä½ç½®å–ã‚ŠãŒã§ããã†ãªé¦¬ã‚’ç‹™ã„ã¾ã™ã€‚")
    lines.append("")
    lines.append("2. **ã‚³ãƒ¼ã‚¹é©æ€§ã¨çµŒé¨“**")
    lines.append("   ã“ã®ã‚³ãƒ¼ã‚¹ã§ã®å®Ÿç¸¾ãŒã‚ã‚‹é¦¬ã‚„ã€ä¼¼ãŸæ¡ä»¶ã§å¥½èµ°ã—ã¦ã„ã‚‹é¦¬ã«æ³¨ç›®ã§ã™ã€‚")
    lines.append("")
    lines.append("3. **èª¿å­ã¨è¿‘èµ°å†…å®¹**")
    lines.append("   ç›´è¿‘ã®ãƒ¬ãƒ¼ã‚¹ã§å¥½å†…å®¹ã‚’ç¤ºã—ã¦ã„ã‚‹é¦¬ã¯ä¿¡é ¼ã§ãã¾ã™ã€‚")
    
    # çµè«–éƒ¨åˆ†ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–
    conclusion_templates = get_conclusion_templates()
    lines.append("")
    lines.append("### ã¾ã¨ã‚")
    if 'ãƒã‚¤ãƒšãƒ¼ã‚¹' in pace:
        lines.append(random.choice(conclusion_templates['ãƒã‚¤ãƒšãƒ¼ã‚¹']))
    elif 'ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹' in pace:
        lines.append(random.choice(conclusion_templates['ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹']))
    else:
        lines.append(random.choice(conclusion_templates['å¹³å‡ãƒšãƒ¼ã‚¹']))

    # è„šè³ªåˆ¥é¦¬åã®æ˜ç¤ºçš„ãªãƒªã‚¹ãƒˆã‚’è¿½åŠ 
    lines.append("")
    lines.append("---")
    lines.append("")
    lines.append("### ğŸ“Š è„šè³ªåˆ¥å‡ºèµ°é¦¬ä¸€è¦§")
    lines.append("")

    # é€ƒã’é¦¬
    if nige_horses:
        lines.append(f"**é€ƒã’**ï¼š{'ã€'.join(nige_horses)}")
    else:
        lines.append("**é€ƒã’**ï¼šè©²å½“ãªã—")

    # å…ˆè¡Œé¦¬
    if senko_horses:
        lines.append(f"**å…ˆè¡Œ**ï¼š{'ã€'.join(senko_horses)}")
    else:
        lines.append("**å…ˆè¡Œ**ï¼šè©²å½“ãªã—")

    # å·®ã—é¦¬
    if sashi_horses:
        lines.append(f"**å·®ã—**ï¼š{'ã€'.join(sashi_horses)}")
    else:
        lines.append("**å·®ã—**ï¼šè©²å½“ãªã—")

    # è¿½è¾¼é¦¬
    if oikomi_horses:
        lines.append(f"**è¿½è¾¼**ï¼š{'ã€'.join(oikomi_horses)}")
    else:
        lines.append("**è¿½è¾¼**ï¼šè©²å½“ãªã—")

    lines.append("")
    lines.append("---")
    lines.append("")
    lines.append("*ã“ã®ãƒ¬ãƒ¼ã‚¹å±•é–‹äºˆæƒ³ã¯ã€éå»ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã¨å„é¦¬ã®è„šè³ªå‚¾å‘ã‚’åŸºã«ã€ViewLogicã‚¨ãƒ³ã‚¸ãƒ³ãŒç®—å‡ºã—ãŸã‚‚ã®ã§ã™ã€‚*")
    lines.append("*å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹ã§ã¯ã€å½“æ—¥ã®é¦¬å ´çŠ¶æ…‹ã‚„å„é¦¬ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šã€äºˆæƒ³ã¨ç•°ãªã‚‹å±•é–‹ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚*")
    
    return "\n".join(lines)